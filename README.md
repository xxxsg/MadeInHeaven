# 融聚邻里 MadeInHeaven 微信小程序文档

计71 康朋 2017050022

## 项目基本情况

​		融聚邻里是中国领先的社区教育服务运营商。目前通过自研的“乐学”业务管理系统，通过自营及赋能覆盖全国超过200家社区。

​		由于社区教育实体店的特性，为了获取更多流量，需要和周边的各种业态机构形成异业合作联盟，每一家校区都会有10-20家异业合作机构，主要业态为各类型教育机构，如亲子早教、亲子游泳、美术机构、音乐舞蹈机构等，餐饮，美容美发、，中小型便利店、健身房等。

​		现有社区的异业合作联盟合作比较松散，不方便统一管理理，可以通过统一联盟卡(Z-Card)的形式提供通用积分服务，在社区周边的所有商家都可以进行积分的积累和消费，实现发行方、社区商业、社区居民三赢的局面。



## 预期目标

​		通过设计和实现社区居民（会员）基础信息、会员等级及升级规则、获取/消费的积分规则以及商家结算规则，搭建出一套前端会员消费、商家结算，后端对规则和数据可进行查看和管理的闭环的业务系统。



## 用户需求

1、会员绑定
2、会员登录
3、会员个人信息查看
4、会员消费信息的产看

​	用户可查询到自己每一笔消费累计的积分详情。

5、会员权益查看

​	用户可查询自己的会员权限，能优惠购买的商品，剩余能使用的积分等。

6、会员积分消费场景的实现

​	用户到商家现场，购买商品或服务时，通过出示个人信息，获取商家折扣或是积分抵用消费金额。



## 需求分析

* **会员绑定**

  会员注册系统。

* **会员登录**

  会员登录，一个验证用户名密码的功能页。

* **会员个人信息查看**

  会员“我的”界面，展示会员的用户昵称、个性签名用户等级、剩余的积分。

  左上角编辑按钮可以更改自己的用户昵称、头像、个性签名，单击头像可以更改密码。

* **会员消费信息的查看**

  会员“我的”界面中下方“消费记录查询”字样，点击查看消费记录，跳转到消费记录界面，用户可以在此界面查看自己过往的每一条记录。

* **会员权益查看**

  在“我的”界面中，单机用户等级右侧的查看详情来查看自己的等级权益。

  等级权益由累计积分决定，由后端计算后传过来并展示。

  店铺详情中可以查看哪些商品可以运用积分进行折扣。

* **会员积分消费场景的实现**

  会员在实体店选好商品后，来到柜台前结算，展示自己的二维码（单击“我的”界面右上角二维码标识），等待商家录入商品；录入完毕后页面将会跳转到“账单”界面，会员查看自己本次消费以及积分运用情况，单击确定或者取消来结束本次交易，此时消费记录等信息生成。



## 设计概要

#### 技术选型

​	微信开发者工具进行编程，整体为`js`、`wxml`、`wxss`，(类似`html`、`css`)；

​	`iView`组件框架；

​	会员登录采用**`WebSocket`**连接，服务器可以给用户推送账单信息。

#### 页面设计

* store-pages/

  * index（小程序主页）

    顶部为滚动推荐栏；

    下方显示店铺列表，单击进入店铺详情页。

  * store-info（店铺详情页）

    上方包括店铺名称、图片、简介、地址、此商铺的折扣信息，包括对于品类的折扣以及满减；

    下方展示店铺拥有的商品卡片，卡片上有花费积分采用折扣价的信息。

  * receive-bill（接收到订单信息）

    当商家发起一笔交易时，会员的小程序跳转到本页面；

    本页面显示本次交易的所有产品信息，包括普通商品的价格，打折商品的原价、现价，以及它们的数量；

    底部显示本次交易消耗、获得的总积分，本次消费的原价、折扣价。

* user-pages/

  * register（注册界面）

    必须输入用于登录的用户名，以及密码和确认密码；

    另外必须输入自己的昵称用于注册；

    注册成功会提示成功，用户名重复会提示用户已注册。
  
  * login（登陆界面）
  
    输入自己的用户名和密码；
    
    输入错误时提示密码错误，成功后自动跳转到用户界面；
    
    下方是“没有账号？注册”字样，点击进入注册界面。
    
  * user（用户界面）
  
      首先上方是用户的头像，往下依次是昵称、签名、等级、剩余积分；
  
      左上角是更改用户信息，右上角展示自己的二维码，头像可以修改自己的密码；
  
      下方分别是消费记录查询字样、登陆/切换用户按钮、退出登陆按钮；
  
      * 左上角更改用户信息
  
        单击进入更改信息界面。
  
      * 右上角展示自己二维码
  
        显示自己的用户名生成的二维码；
  
      * 单击头像
  
        进入更改密码修改界面。
  
      * 查询消费记录
  
        跳转到消费记录界面。
  
  * change-password（更改密码页面）
  
      输入旧密码、新密码、确认新密码进行修改；
  
      旧密码错误会提示错误信息。
  
  * change-user-info（更改用户信息界面）
  
      上方是一个头像栏，单击可以选择本地图片；
  
      下方用户名和个性签名输入框，可以在此编辑自己的信息。
  
  * user-records（消费记录界面）
  
      界面中有n个条目，没个条目均有店铺名、消费时间、购买商品的列表、积分的减少和增加、消费的原价和现价，商品列表是一个折叠栏，单击可以打开；
  
      其中商品列表中有商品的名字、类别、原价、折扣价、消耗积分、获得积分、商品数量。

#### 接口设计

* store-pages/

  * index

    * /api/wechat/get-store-list

      请求信息：无；

      获取信息：商店列表，获取商店详情；

  * store-info

    * /api/wechat/get-goods-list

      请求信息：商家的Id；

      获取信息：商品列表，获取商品详情；

    * api/wechat/get-store-rule

      请求信息：商家的Id；

      获取信息：折扣信息的列表，获取折扣详情；

* user-pages/

  * login

    * /api/wechat/login

      请求信息：会员的用户名、密码；
  
      获取信息：登陆成功与否，用户获得`token`；
  
  * register
  
    * /api/wechat/register
  
      请求信息：需要注册的用户名、密码；
  
      获取信息：注册的成功与否；
  
  * user
  
    * api/wechat/get-user-info
  
      请求信息：会员的用户名以及`token`；
  
      获取信息：会员的信息详情，用户获得新的`token`；
  
    * /api/wechat/get-level-rules
  
      请求信息：会员的用户名以及`token`；
  
      获取信息：等级积分的权益详情，用户获得新的`token`；
  
  * change-password
  
    * /api/wechat/change-password
  
      请求信息：会员的旧密码、新密码以及`token`；
  
      获取信息：修改密码成功与否，用户获得新的`token`；
  
  * change-user-info
  
    * api/wechat/set-head
  
      请求信息：会员的用户名，要上传的头像以及`token`；
  
      获取信息：上传成功与否，用户获得新的`token`；
  
    * /api/wechat/change-user-info
  
      请求信息：会员的用户名，要更改的信息以及`token`；
  
      获取信息：更改成功与否，用户获得新的`token`；
  
  * user-records
  
    * /api/wechat/get-user-records
  
      请求信息：会员的用户名以及`token`；
  
      获取信息：消费记录的列表，获取消费记录的详情，用户获得新的`token`；

#### `WebSocket`

* 连接`WebSocket`（/messageServer）

  请求与服务器连接。

* 监听信息 （`onMessage`）

  接收到信息`dealConfirm`收到交易信息，此时跳转到账单界面，等待用户确认；

* 发送信息 （`sendMessage`）

  用户确认以后，对服务器发送确认或者取消的信息；

* 心跳重连

  微信默认60s对`WebSocket`进行关闭，需要会员和服务器进行持续不断的通信；因此启动一个定时器20s后对服务器进行访问，每次收到回复后再次启动这个定时器；

  设置一个全局变量记录是否为用户主动退出，如果不是，那么在`WebSocket`关闭的时候尝试重连。

## 用户手册

* **打开小程序**

  打开小程序以后映入眼帘的是上端商家推荐栏以及下发商户条目；

  每个商户条目都有相应的简介和地址，会员可以在主页中寻找自己想要消费的店铺，单击进入店铺详情；

* **店铺详情页**

  店铺详情页展示店铺的名称、图片、地址、简介；

  以及店铺优惠详情，包括根据商品类目进行的折扣以及满减；

  下放展示的是商品的卡片，商品显示其品名、类目、价格、能否运用积分进行折扣；

* **登陆界面**

  首次到“我的”界面，时跳到登陆界面，或者在“我的”界面中单击登陆/切换登陆进入登陆界面；

  输入和用户密码，点击登陆进行登陆，登陆完成后跳转至个人信息界面；

  单击密码右侧小眼睛可以开启/关闭密码可见；

  单击登陆下放界面可以进入注册界面；

* **注册界面**

  注册界面中输入登陆所需要的用户名、密码，以及昵称进行注册；

  注册失败会提示注册用户名被占用或者两次密码输入不一致；

* **“我的”界面**

  首先上方是用户的头像，往下依次是昵称、签名、等级、剩余积分；

  左上角是更改用户信息，右上角展示自己的二维码，头像可以修改自己的密码；

  下方分别是消费记录查询字样、登陆/切换用户按钮、退出登陆按钮；

  * 左上角更改用户信息

    单击进入更改信息界面，在昵称和个性签名框内均可修改自己的信息；
    
    单击头像可以上传新的头像；
    
    单击提交进行修改，成功后会有提示；
    
  * 右上角展示自己二维码

    显示自己的用户名生成的二维码；

  * 单击头像

    进入更改密码修改界面，需要输入自己的旧密码，以及新密码和再次确认密码；

    单击提交按钮，当旧密码错误或者两次新密码不一致进行更改失败提示，反之提示成功；

  * 查询消费记录

    跳转到消费记录界面，界面中有n个条目，没个条目均有店铺名、消费时间、购买商品的列表、积分的减少和增加、消费的原价和现价；其中商品列表中有商品的名字、类别、原价、折扣价、消耗积分、获得积分、商品数量。

* **“账单”界面**

  账单界面在没有账单来的时候是空；

  在账单来的时候可以查看本次消费的商品，底部有本次消费消耗和增加的总积分、金额；

  同时单击右下角按钮弹出确认框，这里可以确认/拒绝本次交易。




